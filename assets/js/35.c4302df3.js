(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{362:function(s,t,n){"use strict";n.r(t);var e=n(4),a=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("最近手头做一个项目，左侧菜单这块类似后台管理系统，需要动态的获取到当前用户对应【角色】下面的菜单，需求就是这样的。")]),s._v(" "),t("blockquote",[t("p",[s._v("权限控制 permission.js")])]),s._v(" "),t("ul",[t("li",[s._v("实现方式：通过获取当前用户的权限菜单去比对路由表，生成当前用户具的权限可访问的路由表，通过 router.addRoutes 动态挂载到 router 上。")])]),s._v(" "),t("blockquote",[t("p",[s._v("在main.js中引入permission.js文件，我们再路由钩子beforeEach中做处理，判断是否有token，才往下走，利用vuex对权限路由做控制，保存到state中的addRouters上面，没有值的话我们就做请求，获取权限菜单路由。")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("import router from './router'\nimport store from './store'\nimport { Message } from 'element-ui'\nimport { getToken } from '@/utils/auth' // get token from cookie\nconst whiteList = ['/login']\n\nrouter.beforeEach(async(to, from, next) => {\nif (getToken('token')) {\n\tif (to.path === '/login') {\n\t\t//如果登录了，就跳转首页\n\t\tnext({ path: '/' })\n\t} else {\n\t\tif (!store.getters.addRouters.length) {  //无权限路由，dispatch获取路由\n\t\t\tawait store.dispatch('GetAsyncRoutes').then((res) => {\n\t\t\t\t//此处不知道为啥。。。router.options.routes没有添加的话，addroutes不起作用，还望各位大神指导\n\t\t\t\trouter.options.routes = router.options.routes.concat(store.getters.addRouters)\n\t\t\t\trouter.addRoutes(store.getters.addRouters)\n\t\t\t\tnext({ ...to, replace: true })\n\t\t\t}).catch((err) => {\n\t\t\t\tMessage.error(err || 'Verification failed, please login again')\n\t\t\t\tnext({ path: '/' })\n\t\t\t})\n\t\t} else {\n\t\t\tnext()\n\t\t}\n\t}\n} else {\n\t/* has no token*/\n\tif (whiteList.indexOf(to.path) !== -1) { // 在免登录白名单，直接进入\n\t\tnext()\n\t} else {\n\t\tnext('/login') // 否则全部重定向到登录页\n\t}\n}\n})\n\nrouter.afterEach(() => {\n\t// finish\n})\n\n\n\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br")])]),t("hr"),s._v(" "),t("blockquote",[t("p",[s._v("在store.dispatch('GetAsyncRoutes')中获取，做数据比对，映射。\ndispatch('GetAsyncRoutes') 代码，保存在store文件夹下面，对项目的状态进行管控")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("import { asyncRouterMap, constantRouterMap, constantAfterRouterMap, childrenRouter } from '@/router'\nimport { listSystemMenuByUser } from '@/api/meun'\n\n//asyncRouterMap  是本地存的需要和后端返回权限菜单做比对映射的路由\n//constantRouterMap  主要是存不需要权限的路由  如/login  \n//constantAfterRouterMap   是保存/404 等必须放到路由最后的\n//childrenRouter  存放不是菜单的一些路由。。。感觉有点假哈，菜单哈哈（但是我们菜单权限配置的时候只配左侧主要菜单，详情之类的不配）\n\n【强调一点，/404路由必须放到所有路由的最后，要不然的话，首次加载是没有问题的，刷新页面就会跳转404】\n\n// 计算获取component于path的映射表（打平路由嵌套，由于我们路由就两层，懒得递归了。。。）\nconst LoopForFn = function(data) {\n\tconst biz = []\n\tdata.forEach(v => {\n\t\tif (v.children && v.children.length) {\n\t\t\tv.children.forEach(d => {\n\t\t\t\tbiz.push(d)\n\t\t\t})\n\t\t}\n\t\tbiz.push(v)\n\t})\nreturn biz\n}\n// 根据后台返回的权限菜单树的path 来动态匹配component映射表\nfunction hasPermissionMenu(routerList, hasPermissionData) {\n\tvar list = LoopForFn(asyncRouterMap)\n\thasPermissionData.forEach((v, i) => {\n\t\tlist.forEach(d => {\n\t\t\t//比对后端url和本地的path，如果匹配到了的话，我们就组合响应的菜单\n\t\t\tif (v.url.replace(/^\\s*|\\s*$/g, '') === d.path.replace(/^\\s*|\\s*$/g, '')) {\n\t\t\t\tconst menu = {\n\t\t\t\t\tpath: d.path,\n\t\t\t\t\tcomponent: d.component,\n\t\t\t\t\tname: d.name,\n\t\t\t\t\tmeta: { title: v.name, icon: d.meta.icon },\n\t\t\t\t\thidden: !JSON.parse(v.isUse),\n\t\t\t\t\tchildren: []\n\t\t\t\t}\n\t\t\t\tif (v.children && v.children.length) {  //递归比对\n\t\t\t\t\thasPermissionMenu(menu.children, v.children)\n\t\t\t\t}\n\t\t\t\trouterList.push(menu)\n\t\t\t}\n\t\t})\n\t})\n}\nconst permission = {\n  state: {\n    routers: constantRouterMap,\n    addRouters: []\n  },\n  mutations: {\n    CLEAR: (state, routerList) => {\n      state.addRouters = routerList\n    },\n    SET_ROUTERS: (state, routerList) => {\n      routerList.map(x => {\n        // 过滤详情页等子路由,子路层级也是按照路由表走的，若组合过的权限菜单匹配到映射表里的path，就把映射表里的children追加到权限菜单中\n        const c = childrenRouter.filter(y => y.path === x.path)[0]\n        if (c.children && c.children.length > 0) {\n          x.children = [...x.children, ...c.children]\n        }\n      })\n\t\t\t//更新动态添加的路由，后续有用处\n      state.addRouters = [...routerList, ...constantAfterRouterMap]  //必须把/404路由追加到最后\n      //更新所有的路由\n\t\t\tstate.routers = [...constantRouterMap, ...state.addRouters]\n    }\n  },\n  actions: {\n\t\t//清理动态添加的路由\n    ClearAddRouters({ commit }) {\n      commit('CLEAR', [])\n    },\n\t\t//动态获取权限菜单\n    GetAsyncRoutes({ commit }) {\n      return new Promise(resolve => {\n\t\t\t\t//权限菜单接口\n        listSystemMenuByUser().then(response => {\n          if (!response.data || response.data.length === 0) return\n          const routerList = []\n          hasPermissionMenu(routerList, response.data)\n          commit('SET_ROUTERS', routerList)\n          resolve()\n        })\n      })\n    }\n  }\n}\nexport default permission\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br"),t("span",{staticClass:"line-number"},[s._v("86")]),t("br"),t("span",{staticClass:"line-number"},[s._v("87")]),t("br"),t("span",{staticClass:"line-number"},[s._v("88")]),t("br"),t("span",{staticClass:"line-number"},[s._v("89")]),t("br"),t("span",{staticClass:"line-number"},[s._v("90")]),t("br")])]),t("hr"),s._v(" "),t("blockquote",[t("p",[s._v("到这里基本上的动态获取权限菜单的方式就差不多了，添加就是这么些逻辑。有一点需要注意，在退出的时候一定要清楚添加过的权限菜单，store.dispatch('ClearAddRouters'),不然的话，下次登录的话就不会去调接口，上面这里有个判断")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("if (!store.getters.addRouters.length) {  //无权限路由，dispatch获取路由\n\tawait store.dispatch('GetAsyncRoutes').then((res) => {\n\t\t//此处不知道为啥。。。router.options.routes没有添加的话，addroutes不起作用，还望各位大神指导\n\t\trouter.options.routes = router.options.routes.concat(store.getters.addRouters)\n\t\trouter.addRoutes(store.getters.addRouters)\n\t\tnext({ ...to, replace: true })\n\t}).catch((err) => {\n\t\tMessage.error(err || 'Verification failed, please login again')\n\t\tnext({ path: '/' })\n\t})\n} else {\n\tnext()\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("hr"),s._v(" "),t("blockquote",[t("p",[s._v("vue动态添加路由就到这里了，下回希望讨论一下，组件缓存的问题，项目中也需要用到，keep-alive组件，里面也遇到一些坑，分享出来，希望后来者不必再走弯路。")])]),s._v(" "),t("p",[s._v("有好的见解，欢迎留言，留下联系方式，大家互相沟通！")]),s._v(" "),t("p",[s._v("不喜勿喷，谢谢！")])])}),[],!1,null,null,null);t.default=a.exports}}]);